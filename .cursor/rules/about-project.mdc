---
description: This is overall info about the project
alwaysApply: false
---
# OPEEC Project - Complete Overview & Reference

üèóÔ∏è **PROJECT IDENTITY:**
- **Name:** OPEEC (Equipment Rental Platform)
- **Type:** Backend API Server (Node.js/Express/MongoDB)
- **Purpose:** Equipment rental marketplace connecting equipment owners with renters
- **Architecture:** RESTful APIs + Real-time Socket.IO + Email Services

---

## üèóÔ∏è **PROJECT STRUCTURE:**

```
opeec/
‚îú‚îÄ‚îÄ config/           # Database, environment, Firebase config
‚îú‚îÄ‚îÄ controllers/      # Business logic (15+ controllers)
‚îú‚îÄ‚îÄ models/          # Mongoose schemas (12+ models)
‚îú‚îÄ‚îÄ routes/          # Express route definitions
‚îú‚îÄ‚îÄ middlewares/     # Auth, validation, common middleware
‚îú‚îÄ‚îÄ utils/           # Shared services (email, socket, upload, calculations)
‚îú‚îÄ‚îÄ Workers/         # Background processes (video processing)
‚îú‚îÄ‚îÄ index.js         # Main server entry point
‚îú‚îÄ‚îÄ package.json     # Dependencies and scripts
‚îî‚îÄ‚îÄ .cursor/rules/   # Project standards and guidelines
```

---

## üõ†Ô∏è **TECHNOLOGY STACK:**

### **Core:**
- **Node.js** + **Express.js** - Backend framework
- **MongoDB** + **Mongoose** - Database and ODM
- **Socket.IO** - Real-time communication
- **JWT** - Authentication tokens

### **Services:**
- **Nodemailer** - Email service (SMTP)
- **Azure Blob Storage** - File/image uploads
- **Firebase Admin** - Push notifications
- **Stripe** - Payment processing
- **Node-cron** - Scheduled tasks

### **Key Dependencies:**
- `bcryptjs` - Password hashing
- `moment` - Date manipulation
- `multer` - File upload handling
- `cors` - Cross-origin requests

---

## üìä **DATABASE MODELS & RELATIONSHIPS:**

### **Core Entities:**
```javascript
User (userId) 
‚îú‚îÄ‚îÄ owns ‚Üí Equipment (equipmentId, ownerId)
‚îú‚îÄ‚îÄ creates ‚Üí Order (orderId, userId, equipmentId)
‚îî‚îÄ‚îÄ sends ‚Üí Message (messageId, senderId, receiverId)

Admin (adminId)
‚îú‚îÄ‚îÄ receives ‚Üí AdminNotification (notificationId)
‚îî‚îÄ‚îÄ manages ‚Üí PercentageSetting (pricing configuration)

Categories (categoryId)
‚îú‚îÄ‚îÄ contains ‚Üí SubCategories (embedded)
‚îî‚îÄ‚îÄ used by ‚Üí Equipment (subCategoryId)

Order (orderId)
‚îú‚îÄ‚îÄ references ‚Üí User (userId)
‚îú‚îÄ‚îÄ references ‚Üí Equipment (equipmentId)  
‚îú‚îÄ‚îÄ contains ‚Üí PricingBreakdown (stored fields)
‚îî‚îÄ‚îÄ tracks ‚Üí RentalStatus (Booked‚ÜíDelivered‚ÜíOngoing‚ÜíReturned)
```

### **Key Models:**
- **User:** Authentication, profile, verification status
- **Equipment:** Rental items with images, pricing, location
- **Order:** Complete rental transactions with pricing breakdown
- **AdminNotification:** System notifications with email integration
- **Categories:** Equipment categorization with subcategories
- **Conversation/Message:** Chat system for equipment inquiries
- **PercentageSetting:** Dynamic pricing configuration

---

## üîê **AUTHENTICATION SYSTEM:**

### **JWT Implementation:**
- **User Tokens:** `{ userId, ... }` 
- **Admin Tokens:** `{ adminId, ... }`
- **Middleware:** `req.userId` / `req.adminId` extraction
- **Socket Auth:** JWT validation on connection

### **Access Control:**
- **Public:** Registration, login, equipment listing
- **User Protected:** Profile, orders, chat, equipment submission
- **Admin Protected:** User management, order oversight, notifications

---

## üöÄ **API STRUCTURE & KEY ENDPOINTS:**

### **User APIs (`/user/`):**
- `POST /signup` - User registration with email verification
- `POST /login` - Authentication with JWT response
- `POST /resend-id-card-selfie` - ID verification submission
- `POST /request-account-reactivation` - Appeal blocked accounts

### **Equipment APIs (`/equipment/`):**
- `GET /list` - Browse available equipment with filters
- `GET /details` - Get detailed equipment information
- `POST /add` - Submit equipment for approval (triggers admin notification)
- `PUT /update` - Update equipment (triggers resubmission notification)

### **Order APIs (`/order/`):**
- `POST /add` - Create rental order with complete pricing breakdown
- `PUT /deliver` - Seller marks order as "ready for pickup"; allowed only on or after `rental_schedule.start_date` (returns 400 with message if before)
- `GET /current-rentals` - Active rentals for user/owner
- `GET /history-rentals` - Completed rental history
- `POST /dispute-penalty` - Contest late fees (triggers admin notification)

### **Admin APIs (`/admin/`):**
- **Users:** `/admin/users/*` - User management and verification
- **Equipment:** `/admin/equipment/*` - Equipment approval workflow
- **Orders:** `/admin/orders/*` - Rental oversight and monitoring with complete pricing breakdown
- **Notifications:** `/admin/notifications/list` - Admin notification feed
- **Settings:** `/admin/settings/*` - Platform configuration

### **Chat APIs (`/chat/`):**
- `POST /send-message` - User-to-user equipment inquiries
- `POST /send-support-message` - User-to-admin support tickets
- `POST /admin-reply-support` - Admin responses to support

### **Payment APIs (`/payment/`):**
- `POST /create-intent` - Create Stripe PaymentIntent with Connect integration
- `POST /confirm` - Confirm payment success (optional validation)
- `POST /webhook` - Handle Stripe payment events (refunds, failures)

---

## ‚ö° **REAL-TIME SOCKET EVENTS (STANDARDIZED):**

### **Admin Events:**
- `adminNotification` - New system notifications with email backup
- `adminNotificationUnreadCount` - Live unread count updates

### **Chat Events (STANDARDIZED CONTRACT - Updated Feb 2026):**
| Event | Direction | Purpose |
|-------|-----------|---------|
| `newMessage` | Backend ‚Üí Receiver | Insert new message into UI (status always "sent") |
| `messageStatusUpdated` | Backend ‚Üí Sender | Update message tick/status (sent‚Üídelivered‚Üíread) |
| `typing` | Both | Typing indicators (isTyping: true/false) |

**Removed Legacy Events:**
- ~~`message`~~ - Replaced by `newMessage`
- ~~`messageSent`~~ - Replaced by `messageStatusUpdated`
- ~~`messageDelivered`~~ - Replaced by `messageStatusUpdated`
- ~~`messagesRead`~~ - Replaced by `messageStatusUpdated`
- ~~`newSupportMessage`~~ - Replaced by `newMessage` with `type: "support"`
- ~~`startTyping`/`stopTyping`/`userTyping`~~ - Replaced by `typing`

**Message Status Flow:**
```
sent ‚Üí delivered (when receiver is online) ‚Üí read (when chat is opened)
```

**Payload Standards:**
- Always use `messageId` (not `_id`)
- Always include `conversationId`, `senderId`, `receiverId`

### **Presence Events:**
- `userOnline` / `userOffline` - Connection status
- `joinConversation` / `leaveConversation` - Chat room management

---

## üí∞ **PRICING & FEE CALCULATION:**

### **Dynamic Pricing Model:**
```javascript
// Stored in PercentageSetting model:
{
  adminFeePercentage: 10.0,      // Platform fee
  taxPercentage: 13.0,           // Government tax
  insurancePercentage: 9.0,      // Insurance base rate
  dailyInsuranceMultiplier: 0.015, // Daily insurance scaling
  depositPercentage: 20.1,       // Security deposit rate
  stripeFeePercentage: 1.3       // Payment processing fee
}
```

### **Order Pricing Storage:**
```javascript
// Complete breakdown stored in Order model:
{
  rental_fee: 44.0,           // Base rental amount
  platform_fee: 4.40,        // Admin fee
  tax_amount: 6.29,           // Tax calculation
  insurance_amount: 14.40,    // Insurance (if selected)
  deposit_amount: 24.00,      // Deposit (if selected)
  subtotal: 58.40,           // Pre-tax total
  total_amount: 72.59        // Final amount
}
```

---

## üìß **EMAIL NOTIFICATION SYSTEM:**

### **Email Service (`utils/emailService.js`):**
- **SMTP Configuration:** Hostinger email service
- **Templates:** HTML + Text versions for all emails
- **Types:** OTP verification, Admin notifications

### **Admin Email Notifications:**
Triggered for all admin events with professional templates:
- User registrations, verifications, appeals
- Equipment submissions, resubmissions  
- Rental bookings, late returns, penalty disputes

---

## üîÑ **BUSINESS FLOWS:**

### **Equipment Listing Flow:**
1. User submits equipment ‚Üí Admin notification
2. Admin approves/rejects ‚Üí Status update
3. If rejected + resubmitted ‚Üí Resubmission notification
4. Approved equipment appears in marketplace

### **Rental Flow:**
1. User views equipment ‚Üí Adds to checkout
2. User completes Stripe payment ‚Üí `payment_intent_id` created
3. Order created with payment verification ‚Üí Rental notification + email
4. Status progression: Booked ‚Üí Delivered ‚Üí Ongoing ‚Üí Returned
5. Order completion ‚Üí Automatic payout to owner via Stripe Connect
6. Automated late detection ‚Üí Late return alerts + automatic penalty charging
7. Penalty disputes ‚Üí Admin notification system

### **Payment & Refund Flow (Separate Charges and Transfers - Feb 2026):**
1. **Payment Collection:** User pays via Stripe at booking time ‚Üí funds go to PLATFORM account
2. **Fund Holding:** Platform holds ALL funds until rental completes successfully
3. **Cancellation Refunds:** Simple refund from platform account (no transfer reversal needed)
4. **Late Penalties:** Automatic charges for overdue returns ($50/day default)
5. **Owner Payouts:** Transfer to owner ONLY when order status = "Finished" (via `triggerAutomaticPayout`)
6. **Failed Payments:** Admin notifications for manual collection

**Why Separate Charges (not Destination Charges):**
- Avoids immediate transfers that can't be easily reversed on cancellation
- Prevents negative platform balance when refunds exceed seller's connected account balance
- Platform always has funds available to cover refunds
- Seller sees payout only AFTER successful rental completion

### **Support Flow:**
1. User sends support message ‚Üí Admin socket + email alert
2. Admin replies ‚Üí User receives response
3. Real-time chat with typing indicators

---

## üïê **AUTOMATED PROCESSES:**

### **Cron Jobs (`node-cron`):**
- **Order Status Monitoring:** Automatic status transitions
- **Late Return Detection:** 24+ hour overdue alerts
- **Penalty Application:** Automated late fee calculations

### **Background Workers:**
- **Video Processing:** Equipment video uploads
- **Email Queue:** Async email delivery

---

## üìÅ **KEY UTILITIES:**

### **Core Services:**
- `utils/emailService.js` - Email templates and sending
- `utils/socketService.js` - Socket.IO management
- `utils/feeCalculations.js` - Pricing calculations
- `utils/upload.js` - Azure blob storage integration
- `utils/common_methods.js` - Rating and review calculations

### **Configuration:**
- `config/db.js` - MongoDB connection
- `config/serviceAccount.js` - Firebase credentials
- `config/config.js` - Environment variables

---

## üîß **CURRENT STANDARDS:**

### **API Conventions:**
- Query parameters over path parameters: `?orderId=...`
- Consistent route naming: `/entity/action`
- JWT middleware: `req.userId` / `req.adminId`
- Comprehensive error handling with proper HTTP codes

### **Database Conventions:**
- Mongoose schemas with validation
- Proper indexing for performance
- Reference relationships with populate
- Embedded subdocuments where appropriate

### **Socket Conventions:**
- JWT authentication on connection
- Room-based messaging: `conversation_${id}`
- Typing indicator management
- **Stripe Connect status (Feb 2026):** `requestStripeConnectStatus` ‚Üí `stripeConnectStatusResponse` includes both `status` and `account_status` so app sidebar and create-intent checks stay in sync
- Connection state tracking

---

## üö® **RECENT MAJOR UPDATES:**

### **Stripe Connect: Separate Charges and Transfers (Feb 24, 2026):**
- **CRITICAL FIX:** Changed from "Destination Charges" to "Separate Charges and Transfers"
- **Problem Solved:** Destination Charges transferred money to sellers IMMEDIATELY at payment time, causing:
  - Cancelled orders required transfer reversals (complex, often failed)
  - Sellers showed "future payouts" before rental started
  - Refunds could create negative platform balance if seller withdrew first
- **New Flow:**
  1. Payment goes to platform account first (no `transfer_data.destination`)
  2. Platform holds funds until order is successfully completed
  3. Transfer to seller ONLY when order status = "Finished" (via `triggerAutomaticPayout`)
  4. Cancellation = simple refund from platform (no transfer reversal)
- **Files Changed:**
  - `paymentController.js` - Removed `transfer_data.destination` and `application_fee_amount` from createPaymentIntent
  - `orders.js` - Added `stripe_payout.destination_account_id` storage at order creation
- **No Flutter Changes Required:** Backend-only fix

### **Stripe Webhook Secrets in Database (Feb 2026):**
- **Admin Panel Control:** Webhook secrets can now be edited from Admin Panel ‚Üí Settings
- **Test/Live Mode Switching:** Client can switch between test and live mode by updating both API keys AND webhook secrets from admin panel
- **Database Storage:** `StripeKey` model now stores `webhookSecretPayment`, `webhookSecretConnect`, `webhookSecretIdentity`
- **Fallback to Env Vars:** If DB secrets are empty, system falls back to environment variables
- **Helper Function:** `getWebhookSecret(type)` in `utils/stripeIdentity.js` handles DB-first with env fallback
- **Startup Validation:** Server validates required Stripe env vars at startup (fallback safety net)

### **Stripe Payment Integration:**
- **Payment Collection:** Backend collects payments via Stripe before order creation
- **Separate Charges Model:** Payment goes to platform account first; transfer to seller on order completion
- **Payment Intent Creation:** `/payment/create-intent` creates PaymentIntent WITHOUT immediate transfer
- **Payment Verification:** Orders require valid `payment_intent_id` before creation
- **Automatic Refunds:** Cancellations trigger simple refunds from platform account (no transfer reversal)
- **Late Penalty Charging:** System automatically charges late penalties to saved payment methods
- **Payment Tracking:** Orders store `stripe_payment` (customer payment) + `stripe_payout` (seller transfer)
- **Stripe Customer IDs:** Users get Stripe customer IDs for payment method reuse
- **Webhook Integration:** `/payment/webhook` handles Stripe payment events

### **User Registration & Profile System Overhaul:**
- **New User Verification:** Users start as NOT verified (`isUserVerified: false`) - must complete Stripe Identity verification
- **Verification Status Sync:** `isUserVerified` is now synced with `stripe_verification.status`:
  - When verified ‚Üí `isUserVerified: true`
  - When failed/not_verified ‚Üí `isUserVerified: false`
- **Enhanced Signup Fields:** Added required fields - `age`, `gender`, `DOB`, `address`, `about`
- **Profile Image Required:** `profile_image` is now mandatory, removed `id_card_selfie` requirement
- **Gender Validation:** Limited to `male` and `female` options only
- **Location Schema:** Default `lat: 0.0`, `lng: 0.0` to avoid null values
- **Profile APIs Updated:** Both user and admin profile APIs return standardized field set
- **Update API Enhanced:** User profile update now handles all new required fields with validation

### **Pricing System Overhaul:**
- **Before:** Only stored `rental_fee` and calculated everything dynamically
- **After:** Store complete pricing breakdown (platform_fee, tax_amount, etc.)
- **Impact:** All order APIs now handle complete pricing data

### **Admin Order API Enhancement:**
- **Enhanced Response Structure:** Admin order API now returns comprehensive order details with complete pricing breakdown
- **New Response Format:** Structured response with `order` object and `ui_helpers` for better admin panel experience
- **Pricing Audit Trail:** Includes percentage inputs used for calculations (admin fee, tax, insurance, deposit percentages)
- **Enhanced UI Helpers:** Duration labels, address formatting, and refund preview calculations

### **Admin Notification System:**
- **Real-time socket events** for 8 notification types
- **Email backup system** with professional templates
- **Database persistence** with unread count tracking

### **Email Service Migration:**
- **Centralized service** in `utils/emailService.js`
- **Professional templates** with HTML/text versions
- **OTP and admin notification** email automation

---

## üéØ **DEVELOPMENT GUIDELINES:**

### **Adding New Features:**
1. Create model in `models/`
2. Add business logic in `controllers/`
3. Define routes in `routes/`
4. Add middleware if needed
5. Update this documentation

### **Testing Approach:**
- Manual API testing via Postman
- Socket event testing via temporary functions
- Email testing with real SMTP delivery

### **Code Standards:**
- Follow existing naming conventions
- Add proper error handling
- Include console logging for debugging
- Update admin notifications for relevant events

---

## üìã **QUICK REFERENCE:**

### **Environment Variables:**
- `MONGODB_URI` - Database connection
- `JWT_SECRET` - Token signing
- `EMAIL` / `EMAIL_PASSWORD` - SMTP credentials
- `AZURE_CONNECTION_STRING` - File storage
- `STRIPE_WEBHOOK_SECRET` - **Required** for `/payment/webhook`
- `STRIPE_CONNECT_WEBHOOK_SECRET` - **Required** for `/webhooks/stripe-connect` and Identity webhook fallback
- `STRIPE_IDENTITY_WEBHOOK_SECRET` - Optional (falls back to CONNECT secret) for `/user/verification/webhook`
- `STRIPE_PLATFORM_COUNTRY` - Optional, defaults to 'CA' for cross-border payment detection

### **Default Ports:**
- Server: 5001
- MongoDB: Default (27017)
- Socket.IO: Same as HTTP server

### **Key Constants:**
- Admin fee: 10%
- Tax rate: 13%
- Insurance: 9% + daily multiplier
- Deposit: 20.1%

---

## üè¶ **WALLET & WITHDRAWALS MODULE:**

### **New Models (Additive):**
- **SellerWallet:** Cached balance tracking per seller (available, pending, total)
- **TransactionLog:** Complete audit trail of all money movements with types
- **WithdrawalRequest:** Seller payout requests with admin approval workflow

### **New Endpoints (Additive):**
- `GET /wallet` - **UNIFIED wallet API** - returns balance, pending withdrawals, and history in single response
- `POST /withdrawals` - Create withdrawal request (validates available balance)
- `GET /withdrawals` - Seller's own withdrawal requests (deprecated - use unified wallet API)
- `GET /admin/withdrawals` - Admin withdrawal review dashboard
- `POST /admin/withdrawals/:id/approve` - Admin approval (requires transaction_id + optional screenshot_url)
- `POST /admin/withdrawals/:id/reject` - Admin rejection (requires transaction_id + rejection_reason)
- `POST /admin/withdrawals/:id/mark-paid` - Admin mark as paid (requires transaction_id + optional screenshot_url)

### **Settlement Integration:**
- **Order Completion:** Credits rental_fee to seller as ORDER_EARNING
- **Cancellations:** Processes refunds based on timing (before/after cutoff)
- **Late Returns:** Handles penalties that exceed deposit coverage
- **Deposit Refunds:** Tracks deposit returns to renters

### **Key Features:**
- **Additive Only:** Zero impact on existing API contracts or Stripe flows
- **Audit Trail:** Complete transaction history with order references
- **Balance Caching:** Fast wallet queries with background recomputation
- **Admin Workflow:** Request ‚Üí Review ‚Üí Approve (with transaction_id) ‚Üí Pay OR Request ‚Üí Review ‚Üí Reject (with transaction_id + reason)
- **Unified Mobile API:** Single `/wallet` endpoint returns balance, pending withdrawals, and history
- **Transaction ID Requirements:** All admin actions (approve/reject/paid) require transaction_id for audit trail
- **Settlement Automation:** Listens to existing order lifecycle events

### **Recent Updates (Latest Session):**
- **Enhanced Admin Workflow:** Both approval and rejection now require transaction_id from admin
- **Unified Wallet API:** Single endpoint returns all wallet data matching mobile UI requirements  
- **Dummy Data:** Added test data for emailadress208@gmail.com with $23.0 balance and withdrawal history
- **Withdrawal Status Flow:** Pending ‚Üí Approved (transaction_id + screenshot) OR Rejected (transaction_id + reason)
- **Geospatial Index Fix:** Fixed $geoNear errors by adding proper 2dsphere index to Equipment model location.coordinates field with automatic lat/lng‚ÜíGeoJSON conversion
- **Equipment getAllEquipments API Enhancement:** 
  - Lat/lng parameters now optional (0.0 or missing = show all equipment)
  - Distance-based filtering with equipment range logic (delivery_by_owner consideration)
  - Reservation text now only shows FUTURE reservations (past dates return empty string)
  - Reservation date/time formatted in UTC (getReservationText) so "Reserved till DD/MM/YY" matches stored end_date regardless of server timezone

---

## üìÖ **RENTAL DATE & TIMEZONE SYSTEM (Feb 2026):**

### **Days-Only Rental System:**
- **Unit:** All rental durations are in DAYS only (no hours/weeks/months)
- **Notice Period:** 0-5 days (0 = same-day allowed with 5 PM cutoff)
- **Min Duration:** 1-5 days
- **Max Duration:** 1, 2, 3, 4, 5, 6, 7, 14, 30 days

### **Simplified Duration Field Storage (Feb 2026):**
- **Database:** Duration fields (`notice_period`, `minimum_trip_duration`, `maximum_trip_duration`) stored as plain numbers (days)
- **API Output:** `toJSON`/`toObject` transforms wrap values as `{ selectedValue: N }` for Flutter compatibility
- **API Input:** Backend `extractDaysFromDuration()` accepts:
  - Plain numbers: `1`, `2`, `3`
  - Objects: `{ selectedValue: N }`, `{ count: N }`, `{ dropdownId: "", selectedValue: N }`
- **Flutter Parsing:** `DurationModel.fromJson()` extracts from both `count` and `selectedValue` keys
- **Editing Flow:** Flutter uses numeric value matching to find/display dropdown options (not ObjectId lookup)

### **Rental Days Calculation:**
```
Same day (17‚Üí17) = 1 day
17‚Üí18 = 1 day  
17‚Üí19 = 2 days
Formula: diff < 1 ? 1 : diff
```

### **5 PM Same-Day Cutoff:**
- When notice_period = 0, same-day booking only available before 5 PM local time
- After 5 PM, earliest start date is tomorrow
- Enforced in both Flutter app and backend

### **Renter Timezone Handling:**
- **Order Model:** New `renter_timezone` field stores renter's timezone
- **Flutter App:** Sends device timezone (e.g., "PST", "EST") with addOrder
- **Backend:** Maps abbreviations to IANA names (PST‚ÜíAmerica/Vancouver, EST‚ÜíAmerica/Toronto, etc.)
- **Fallback:** America/Toronto when timezone unknown

### **Late/Penalty Calculation:**
- Uses renter's timezone for fairness
- End of last rental day = 23:59:59.999 in renter's timezone
- Order marked Late only AFTER end of day in renter's timezone

### **Canadian Timezone Mapping:**
```javascript
PST/PDT ‚Üí America/Vancouver
MST/MDT ‚Üí America/Edmonton  
CST/CDT ‚Üí America/Winnipeg
EST/EDT ‚Üí America/Toronto
AST/ADT ‚Üí America/Halifax
NST/NDT ‚Üí America/St_Johns
```

### **Key Files Modified:**
- `models/orders.js` - Added renter_timezone field
- `models/equipmentDropDown.js` - Days-only unit enum
- `controllers/orders.js` - Notice/cutoff validation, timezone resolution, late detection
- `controllers/equipmentDropDown.js` - Days-only validation with value ranges
- `scripts/seedEquipmentDropdowns.js` - Seed script for dropdown options

### **Dependencies Added:**
- `moment-timezone` - For timezone-aware date calculations in backend

---

## üí¨ **CHAT MODULE REAL-TIME SYSTEM (Feb 2026):**

### **Notification Filtering:**
- **Chat Tab Tracking:** `ChatStateTracker.isOnChatTab()` - true when user is on chat list
- **Active Conversation:** `ChatStateTracker.isConversationActive(id)` - true when user is in specific chat
- **Push Notification Filter:** Foreground chat notifications suppressed when user is on chat tab or in that conversation

### **Chat List Real-Time Updates:**
- **Socket Events Handled:** `newMessage`, `messageStatusUpdated` (STANDARDIZED)
- **Auto-Sorting:** Conversations sorted by `updatedAt` (most recent first) after each update
- **Typing Indicator:** Shows "typing..." in chat list via `typing` event
- **Unread Count Logic:** Only increments if:
  1. Message is NOT from current user
  2. User is NOT in that specific conversation

### **Chat Detail Real-Time:**
- **Instant Messages:** `newMessage` event inserts messages (deduplicated by messageId)
- **Status Updates:** `messageStatusUpdated` event updates tick/status (sent‚Üídelivered‚Üíread)
- **Typing Indicators:** `typing` event with `isTyping: true/false`
- **Race Condition Handling:** Pending status queue for updates arriving before messages

### **Sync Between Chat List & Detail:**
- **Background Updates:** Chat list model updates via socket even when user is in chat room
- **Return Callback:** When leaving chat room, passes `lastMessageObj` to update chat list
- **Conversation Joining:** `joinConversation` socket event marks user as active in conversation

### **Delivery Logic:**
- **Online Check:** Uses `connectedUsers.has(userId)` - socket-level presence
- **NOT** `isUserJoinedToConversation` (that only tracks if user opened specific chat)

### **Cache-First Loading:**
- **Flutter Implementation:** Shows cached `getUserConversationModel` immediately
- **Background Refresh:** API call updates in background without loading indicator if cache exists
- **No Stale Overwrite:** Socket updates always use latest timestamp for sorting

### **Key Classes & Methods (Flutter):**
```dart
// Utility class for tracking chat state (notification filtering)
ChatStateTracker
‚îú‚îÄ‚îÄ setOnChatTab(bool)      // Called when entering/leaving chat list
‚îú‚îÄ‚îÄ isOnChatTab()           // Check if user is on chat tab
‚îú‚îÄ‚îÄ setActiveConversation(String?)  // Called when entering/leaving chat room
‚îú‚îÄ‚îÄ isConversationActive(String)    // Check if user is in specific chat
‚îî‚îÄ‚îÄ shouldShowChatNotification(String)  // Combined check for notification display
```

### **Files Modified:**
- `main_chat_screen.dart` - Added ChatStateTracker, typing indicators, cache-first loading
- `chat_room.dart` - Integrated ChatStateTracker for conversation tracking
- `push_notification.dart` - Added chat notification filtering

---

## üîß CHAT MODULE AUDIT & FIXES (Feb 2026)

### **Critical Bugs Fixed:**

#### 1. Socket Listener Duplication (CRITICAL)
- **Issue:** Listeners accumulated across screen rebuilds causing duplicate events
- **Fix:** Added `_listenersInitialized` flag guard in `chat_room.dart` and `chat_support_screen.dart`
- **Files:** `chat_room.dart`, `chat_support_screen.dart`

#### 2. Typing Indicator Timeout Missing (MODERATE)
- **Issue:** Typing indicator stayed forever if stop event wasn't received
- **Fix:** Added 5-second auto-clear timer in both `main_chat_screen.dart` and `chat_room.dart`
- **Implementation:** `_typingTimers` map with Timer cleanup in dispose

#### 3. Race Condition: Socket vs API (CRITICAL)
- **Issue:** API response could overwrite newer socket data
- **Fix:** Added timestamp comparison in `ChatController.getConversationMethod()` 
- **Logic:** Preserves conversation with newer `updatedAt` timestamp

#### 4. Broken Unread Count in Support Messages (CRITICAL)
- **Issue:** Unread count logic was commented out, always incrementing
- **Fix:** Restored conditional logic: `shouldIncrementUnread ? +1 : 0`
- **File:** `main_chat_screen.dart` (`_handleSupportMessage`)

#### 5. Wrong Last Message on Exit (BUG)
- **Issue:** `_onWillPop` returned `messages.first` (oldest) instead of `.last` (newest)
- **Fix:** Changed to `messages.last` for correct last message
- **File:** `chat_room.dart`

#### 6. Socket Reconnection Not Rejoining Conversations (CRITICAL)
- **Issue:** After socket disconnect/reconnect, conversations weren't rejoined
- **Fix:** Added conversation tracking in `SocketHelper`:
  - `trackJoinConversation(id)` / `trackLeaveConversation(id)`
  - `_rejoinConversations()` called on reconnect
- **Files:** `socket_helper.dart`, `socket_controller.dart`

#### 7. Missing ChatStateTracker in Support Screen
- **Issue:** Support chat didn't integrate with notification filtering
- **Fix:** Added `ChatStateTracker.setActiveConversation()` in init/dispose
- **File:** `chat_support_screen.dart`

#### 8. Message Alignment Inverted (CRITICAL UI BUG)
- **Issue:** Sender messages aligned LEFT, receiver messages aligned RIGHT (backwards)
- **Fix:** Changed alignment logic: `sentByYou ? Alignment.centerRight : Alignment.centerLeft`
- **Files:** `chat_room.dart`, `chat_support_screen.dart`

#### 9. Missing Status Ticks in Chat Room (MODERATE)
- **Issue:** Chat detail view didn't show sent/delivered/read tick icons
- **Fix:** Added optional `status` parameter to `_buildMessageBubble()` with tick icons:
  - Single grey tick = sent
  - Double grey tick = delivered  
  - Double blue tick = read
- **File:** `chat_room.dart`

### **Architecture Improvements:**

```dart
// Socket Helper - Conversation Tracking for Reconnection
SocketHelper
‚îú‚îÄ‚îÄ _joinedConversations: Set<String>    // Track active conversations
‚îú‚îÄ‚îÄ trackJoinConversation(id)            // Called by joinConversation
‚îú‚îÄ‚îÄ trackLeaveConversation(id)           // Called by leaveConversation  
‚îî‚îÄ‚îÄ _rejoinConversations()               // Auto-rejoin on reconnect

// Main Chat Screen - Typing Timeout Management
_MainChatScreenState
‚îú‚îÄ‚îÄ _typingTimers: Map<String, Timer>    // Per-conversation timeout
‚îú‚îÄ‚îÄ _setupTypingListeners()              // 5-second auto-clear
‚îî‚îÄ‚îÄ dispose()                            // Cancel all timers

// Chat Controller - Race Condition Prevention
ChatController.getConversationMethod()
‚îú‚îÄ‚îÄ Store pre-API timestamps
‚îú‚îÄ‚îÄ Compare API response timestamps
‚îî‚îÄ‚îÄ Preserve newer socket data
```

### **Verified Working:**
- ‚úÖ Socket listeners register once per screen instance
- ‚úÖ Typing indicators auto-clear after 5 seconds
- ‚úÖ Socket reconnection auto-rejoins conversations
- ‚úÖ API responses don't overwrite newer socket data
- ‚úÖ Unread counts correctly increment/decrement
- ‚úÖ ChatStateTracker works across all chat screens
- ‚úÖ Navigation clears conversation state properly
- ‚úÖ Message alignment: sender RIGHT, receiver LEFT
- ‚úÖ Status ticks display in chat room (sent/delivered/read)
- ‚úÖ Chat list shows correct status icons for last message

---

This comprehensive overview ensures Cursor understands the complete OPEEC project structure, business logic, and current implementation without needing to search through individual files.