---
description: For any socket based work
alwaysApply: false
---
ğŸ“¡ SOCKET RULE â€” UNIVERSAL BACKEND REAL-TIME STANDARD

Defines project-wide conventions for scalable, context-aware socket implementation.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ“ FILE LOCATION:
- Place all socket logic in: utils/socketManager.js
- Organize handlers modularly per feature (e.g., chat, presence, activity)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ” AUTHENTICATION:
- Authenticate on socket connect using JWT
- Extract userId (or equivalent)
- Reject if invalid
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ  ROOM NAMING CONVENTION:
- Personal room:     user:{userId}
- Feature-specific:  feature:{contextId}

Example:
  user:23
  thread:abc123
  board:task-987
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ§  USER CONTEXT STATE (In-Memory or Redis):
Track each userâ€™s active view context:
{
  [userId]: {
    inOverviewView: boolean,
    activeContextId: string | null
  }
}
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âš™ï¸ AUTOMATED CONTEXT DETECTION (KEY RULE):
âœ… The backend must automatically track context and emit relevant socket events
   by detecting API calls (e.g., list/detail views).

Examples:
  - On overview API call:
      â†’ set inOverviewView = true, activeContextId = null
      â†’ emit any relevant updates (e.g., unread summaries)

  - On detail-level API (e.g., fetch item/page 1):
      â†’ set activeContextId = ID
      â†’ auto-exit previously active context
      â†’ emit context-specific data (e.g., reset unread)

  - On "exit overview" (only client-emitted event):
      â†’ clear both inOverviewView & activeContextId
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ“¶ SOCKET EVENT RULES:

SERVER EMITS:
âœ” feature-updated
âœ” item-created
âœ” new-message
âœ” unread-count-updated
âœ” user-typing / typing-stopped

CLIENT EMITS (ONLY WHEN NOT INFERABLE):
âœ” user-typing         { contextId }
âœ” typing-stopped      { contextId }
âœ” exit-overview       (no body)

DO NOT REQUIRE CLIENT TO EMIT:
âœ– enter-overview
âœ– enter-context
âœ– send-message
â†’ These should be inferred from API usage
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ’¬ IF MESSAGING FEATURE IS PRESENT:

SERVER BEHAVIOR:
- Send messages via REST
- On send:
  â†’ emit new-message to context room
  â†’ emit unread-count-updated to users in overview view
  â†’ emit new-message (with unread counts) to users in other contexts

UNREAD LOGIC:
- Track lastReadTimestamps per user/context
- Reset on context entry
- Only emit unread to users with visible UI states

CLIENT LISTENERS:
âœ” new-message              { message, unreadSummary? }
âœ” unread-count-updated     { contextId, count }
âœ” user-typing / stopped    { userId, contextId }

CLIENT EMITS (MINIMAL):
âœ” user-typing              { contextId }
âœ” typing-stopped           { contextId }
âœ” exit-overview            (no body)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âœ… BEST PRACTICES:

- Use context-aware emission â€” only emit if user is in a relevant state
- Prefer server-driven inference to reduce fragile client logic
- Room naming must stay consistent and predictable
- Separate logic per feature for scalability
- Use helper functions for: trackState(), emitToContext(), joinRooms()

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

